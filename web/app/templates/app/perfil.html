{% extends 'app/base.html' %}
{% load static %}

{% block title %}Perfil{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/perfil_conectati.css' %}">
{% endblock %}

{% block encabezado_unificado %}{% endblock %}

{% block contenido %}
    <!-- Cabecera del perfil -->
    <div class="area-perfil">
      <div class="perfil-header">
        <div class="franja-azul">
          <img class="avatar" src="{% if usuario_perfil.foto %}{{ usuario_perfil.foto }}{% else %}{% static 'images/default_user.avif' %}{% endif %}" alt="{{ usuario_perfil.nombre }}" />
          <div class="info-texto">
            <h2>{{ usuario_perfil.nombre }}</h2>
            <p class="usuario">@{{ usuario_perfil.username }}</p>
            <p class="bio">{{ usuario_perfil.descripcion }}</p>
          </div>
          {% if es_propio_perfil %}
          <a class="editar-perfil" href="{% url 'editprofile' %}">
            <span>Editar perfil</span>
          </a>
          {% else %}
            <div class="perfil-botones-acciones">
              {% if estado_amistad == None %}
              <button id="btn-aniadir-amigo" class="editar-perfil" onclick="enviarSolicitudAmistad('{{ usuario_perfil.id }}')">
                  <span>Añadir amigo</span>
              </button>
              {% elif estado_amistad == 'pendiente' %}
              <button class="editar-perfil" disabled style="cursor:not-allowed;opacity:0.7;">
                <span>Pendiente</span>
              </button>
              {% elif estado_amistad == 'aceptada' %}
              <button class="editar-perfil" disabled style="cursor:not-allowed;opacity:0.7;">
                <span>Amigo</span>
              </button>
              {% endif %}
              {% if estado_chat == None %}
              <button id="btn-chatear" class="editar-perfil" onclick="enviarSolicitudChat('{{ usuario_perfil.id }}')">
                  <span>Chatear</span>
              </button>
              {% elif estado_chat == 'pendiente' %}
              <button class="editar-perfil" disabled style="cursor:not-allowed;opacity:0.7;">
                <span>Chat pendiente</span>
              </button>
              {% elif estado_chat == 'aceptada' %}
              <a href="{% url 'chat' %}" class="editar-perfil" style="background:#5793fb;">
                <span><i class="fas fa-comments"></i> Ir al chat</span>
              </a>
              {% endif %}
            </div>
          {% endif %}
        </div>
        <div class="barra-inferior">
          <span><strong>{{ cantidad_amigos }}</strong> Amigos</span>
        </div>
      </div>

      <!-- Publicaciones -->
      {% if publicaciones %}
      {% for post in publicaciones %}
        <div class="post">
          <div class="post-header">
            <img class="avatar" src="{% if post.usuario.foto %}{{ post.usuario.foto }}{% else %}{% static 'images/default_user.avif' %}{% endif %}" alt="{{ post.usuario.nombre }}" />
            <div class="info-texto">
              <strong>{{ post.usuario.nombre }}</strong>
              <span class="usuario">@{{ post.usuario.username }}</span>
            </div>
          </div>

          <p class="post-texto">{{ post.texto }}</p>

          {% if post.archivo_nombre %}
            <img class="post-image" src="/media/publicaciones/{{ post.archivo_nombre }}" alt="Imagen de la publicación">
          {% endif %}

          <div class="post-acciones">
            <button class="accion"><i class="far fa-star"></i> {{ post.estrellas }}</button>
            <button class="accion comentario-btn"><i class="far fa-comment"></i> 0</button>
          </div>
          <div class="meta">{{ post.fecha|time:"H:i" }} · {{ post.fecha|date:"d/m/Y" }}</div>
        </div>
      {% endfor %}
      {% else %}
        <p style="text-align:center; color: #888; margin-top: 2rem;">Este usuario aún no tiene publicaciones.</p>
      {% endif %}
    </div>
{% endblock %} 

{% block extra_js %}
{{ block.super }}
<script>
function enviarSolicitudAmistad(para_usuario_id) {
    var btn = document.getElementById('btn-aniadir-amigo');
    btn.disabled = true;
    btn.querySelector('span').innerText = 'Enviando...';
    fetch("{% url 'enviar_solicitud_amistad' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ para_usuario_id: para_usuario_id })
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            btn.querySelector('span').innerText = 'Pendiente';
            btn.disabled = true;
            btn.style.cursor = 'not-allowed';
            btn.style.opacity = '0.7';
        } else {
            btn.querySelector('span').innerText = data.error || 'Error';
            btn.disabled = false;
        }
    })
    .catch(err => {
        btn.querySelector('span').innerText = 'Error';
        btn.disabled = false;
    });
}

function enviarSolicitudChat(para_usuario_id) {
    var btn = document.getElementById('btn-chatear');
    btn.disabled = true;
    btn.querySelector('span').innerText = 'Enviando...';
    fetch("/app/enviar-solicitud-chat/", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ para_usuario_id: para_usuario_id })
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok || (data.error && data.error.includes('Ya existe solicitud'))) {
            // Oculta el botón de chatear y muestra el de pendiente
            btn.outerHTML = `<button class='editar-perfil' disabled style='cursor:not-allowed;opacity:0.7;'><span>Chat pendiente</span></button>`;
        } else {
            alert(data.error || 'Error enviando solicitud');
            btn.querySelector('span').innerText = 'Chatear';
            btn.disabled = false;
        }
    })
    .catch(err => {
        btn.querySelector('span').innerText = 'Error';
        btn.disabled = false;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
